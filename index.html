<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Ramadan Tracker Pro</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            /* –ù–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ Dark & Gold */
            --bg-body: #080a0f;
            --bg-gradient: radial-gradient(circle at 50% -20%, #1e2838 0%, #080a0f 60%);
            
            --accent: #d4af37;
            --accent-glow: rgba(212, 175, 55, 0.3);
            --accent-dim: rgba(212, 175, 55, 0.1);
            
            --glass-bg: rgba(30, 41, 59, 0.4);
            --glass-border: rgba(255, 255, 255, 0.08);
            
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --text-tertiary: #475569;
            
            --green: #27ae60;
            --red: #e74c3c;
            --blue: #3498db;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            background-color: var(--bg-body) !important;
            background-image: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-primary) !important;
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; padding: 0; 
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-user-select: none; user-select: none;
        }
        
        body.no-scroll { overflow: hidden !important; height: 100vh; position: fixed; width: 100%; }

        input, textarea { -webkit-user-select: text !important; user-select: text !important; }

        /* –ü–ê–†–ê–õ–õ–ê–ö–° –§–û–ù (–∑–≤–µ–∑–¥—ã –æ—Å—Ç–∞–≤–∏–º –¥–ª—è –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã, –Ω–æ —á—É—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ) */
        #star-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; overflow: hidden;
        }
        .star-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; will-change: transform; }
        .stars-1 { width: 1px; height: 1px; background: transparent; box-shadow: 10vw 10vh #fff, 20vw 50vh #fff, 30vw 20vh #fff, 80vw 80vh #fff; opacity: 0.6; }
        .stars-2 { width: 2px; height: 2px; background: transparent; box-shadow: 55vw 15vh #fff, 25vw 85vh #fff; opacity: 0.4; }

        .container { 
            max-width: 450px; margin: 0 auto; padding: 20px; 
            padding-bottom: 160px; position: relative; z-index: 10; 
        }

        /* UI –≠–õ–ï–ú–ï–ù–¢–´ */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-mini {
            background: rgba(255, 255, 255, 0.05); color: var(--text-secondary); padding: 10px 16px; border-radius: 20px;
            font-size: 13px; font-weight: 600; border: 1px solid var(--glass-border);
            cursor: pointer; backdrop-filter: blur(10px); font-family: 'Manrope', sans-serif; transition: 0.2s;
            position: relative; z-index: 20; display: flex; align-items: center; gap: 6px;
        }
        .btn-mini i { font-size: 16px; color: var(--accent); }
        
        .brand-link {
            display: block; text-align: center; font-size: 11px; color: var(--text-tertiary);
            text-decoration: none; font-weight: 500; margin-bottom: 15px; letter-spacing: 1px; text-transform: uppercase;
            position: relative; z-index: 20;
        }

        /* --- –ù–û–í–´–ô –î–ò–ó–ê–ô–ù –ö–†–£–ì–ê --- */
        .progress-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; position: relative; z-index: 11; }
        .circle-wrapper { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 10px; width: 100%; }
        
        .nav-arrow { 
            font-size: 24px; color: var(--text-tertiary); padding: 15px; cursor: pointer; transition: 0.2s; 
            background: rgba(255,255,255,0.03); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
        }
        .nav-arrow:active { transform: scale(0.9); background: rgba(255,255,255,0.1); color: #fff; }
        .nav-arrow.disabled { opacity: 0.1; pointer-events: none; }
        
        .circle-container { position: relative; width: 180px; height: 180px; margin: 0 10px; }
        svg { width: 100%; height: 100%; overflow: visible; }
        circle { fill: none; stroke-width: 4; stroke-linecap: round; }
        
        .circle-bg { stroke: rgba(255, 255, 255, 0.05); }
        .circle-progress { 
            stroke: var(--accent); 
            stroke-dasharray: 330 440; /* 330 –≤–∏–¥–∏–º–∞—è —á–∞—Å—Ç—å, 110 —Ä–∞–∑—Ä—ã–≤ */
            stroke-dashoffset: 330; 
            transition: stroke-dashoffset 0.8s ease, stroke 0.6s ease; 
            filter: drop-shadow(0 0 15px var(--accent-glow)); 
        }
        
        .day-info { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; margin-top: 5px; }
        .day-number { 
            font-size: 64px; font-weight: 200; letter-spacing: -2px; line-height: 1; 
            background: linear-gradient(180deg, #fff 20%, #a5b4fc 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .day-label { 
            font-size: 13px; color: var(--text-secondary); text-transform: uppercase; 
            letter-spacing: 2px; font-weight: 600; margin-top: 5px;
        }
        
        .greeting-text { text-align: center; font-size: 14px; color: var(--text-secondary); line-height: 1.5; font-weight: 400; opacity: 0.8; margin-top: -10px; }

        #syncStatus { font-size: 11px; text-align: center; color: var(--text-tertiary); height: 20px; line-height: 20px; margin-bottom: 10px; font-weight: 600; transition: color 0.3s; }
        #syncStatus.active { color: var(--green); }

        /* --- –ù–û–í–´–ô –î–ò–ó–ê–ô–ù –ö–ê–†–¢–û–ß–ï–ö --- */
        .tracker-section { 
            background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border-radius: 24px; 
            padding: 24px; 
            margin-bottom: 16px; 
            border: 1px solid var(--glass-border); 
            border-top: 2px solid var(--accent); /* –ó–æ–ª–æ—Ç–æ–π –≤–µ—Ä—Ö */
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3);
            position: relative; z-index: 11;
        }

        .section-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; }
        .section-title { font-size: 16px; font-weight: 700; color: #fff; display: flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 1px;}
        .section-title i { font-size: 20px; color: var(--accent); }
        
        .section-percent { 
            font-size: 32px; font-weight: 200; color: #ffffff; letter-spacing: -1px; line-height: 1;
        }

        .progress-bar-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 20px; overflow: hidden; }
        .progress-bar-fill { height: 100%; width: 0%; background: var(--accent); border-radius: 6px; transition: width 0.3s ease, background-color 0.3s ease; box-shadow: 0 0 10px var(--accent-glow); }
        
        .group-label { font-size: 10px; text-transform: uppercase; color: var(--text-tertiary); font-weight: 700; margin-top: 20px; margin-bottom: 12px; letter-spacing: 1.5px; }
        
        .task-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,0.03); cursor: pointer; }
        .task-item:last-child { border-bottom: none; }
        .task-text { font-size: 15px; font-weight: 400; color: var(--text-secondary); flex-grow: 1; transition: color 0.2s;}
        .task-item.checked .task-text { color: #fff; }
        
        .checkbox { width: 22px; height: 22px; border-radius: 6px; border: 1px solid var(--text-tertiary); display: flex; align-items: center; justify-content: center; transition: all 0.2s; background: transparent; flex-shrink: 0; }
        .task-item.checked .checkbox { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }
        .checkbox::after { content: '‚úì'; font-size: 14px; display: none; font-weight: 800; color: #000; }
        .task-item.checked .checkbox::after { display: block; }
        
        /* FASTING TOGGLE UPDATE */
        .fasting-switch {
            display: flex; background: rgba(0,0,0,0.3); border-radius: 16px; padding: 4px;
            margin-bottom: 20px; border: 1px solid var(--glass-border);
        }
        .fasting-option {
            flex: 1; text-align: center; padding: 14px; font-size: 14px; font-weight: 600;
            color: var(--text-tertiary); cursor: pointer; border-radius: 12px; transition: 0.3s;
        }
        .fasting-option.active-nothold { background: rgba(255,255,255,0.05); color: var(--text-secondary); }
        .fasting-option.active-hold { background: var(--accent); color: #000; box-shadow: 0 0 20px var(--accent-glow); font-weight: 700;}

        /* TIMES */
        .fasting-times-block {
            background: rgba(0,0,0,0.2); border-radius: 16px; padding: 15px;
            border: 1px solid rgba(255,255,255,0.03); text-align: center; margin-bottom: 5px;
        }
        .time-row { display: flex; justify-content: space-around; align-items: center; }
        .time-label { font-size: 10px; color: var(--text-tertiary); text-transform: uppercase; margin-bottom: 4px; letter-spacing: 1px; }
        .time-val { font-size: 22px; font-weight: 300; color: #fff; }

        /* INPUTS & OTHERS */
        .custom-input { flex: 1; border: 1px solid #333; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 12px; font-size: 14px; color: #fff; outline: none; font-family: 'Manrope', sans-serif; transition: border 0.2s; }
        .custom-input:focus { border-color: var(--accent); }
        .btn-plus { width: 44px; background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 12px; color: var(--accent); font-size: 24px; font-weight: 300; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .water-glass { width: 22px; height: 30px; cursor: pointer; position: relative; opacity: 0.3; transition: 0.3s; }
        .water-glass.filled { opacity: 1; transform: scale(1.1); }
        .water-glass.filled path { fill: var(--blue); stroke: var(--blue); filter: drop-shadow(0 0 8px rgba(52, 152, 219, 0.6)); }

        .page-input { width: 70px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: var(--accent); padding: 8px; border-radius: 8px; font-size: 14px; font-weight: 700; text-align: center; margin-right: 10px; }

        .stars { display: flex; justify-content: center; gap: 8px; margin-top: 10px; }
        .star { font-size: 32px; color: #333; cursor: pointer; transition: color 0.2s; }
        .star.active { color: var(--accent); text-shadow: 0 0 15px var(--accent-dim); }
        
        .journal-area { width: 100%; height: 120px; background: rgba(0,0,0,0.2); border: 1px solid #333; border-radius: 16px; padding: 15px; color: #fff; font-family: 'Manrope', sans-serif; font-size: 14px; resize: none; margin-top: 5px; line-height: 1.5; }

        .bottom-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; }
        .btn-finish { background: #fff; color: #000; width: 100%; padding: 18px; border: none; border-radius: 20px; font-size: 14px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-family: 'Manrope', sans-serif; box-shadow: 0 0 20px rgba(255, 255, 255, 0.1); position: relative; z-index: 50; transition: background 0.3s; }
        .btn-finish.saved { background: var(--green); color: white; box-shadow: 0 0 20px rgba(39, 174, 96, 0.4); }
        .btn-share { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; color: #fff; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; text-transform: uppercase; position: relative; z-index: 50; backdrop-filter: blur(10px); }

        /* MODALS */
        .modal-overlay { position: fixed; bottom: 0; left: 0; width: 100%; height: 100%; background: #090e16; border-top-left-radius: 28px; border-top-right-radius: 28px; box-shadow: 0 -10px 50px rgba(0,0,0,0.8); transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 200; display: flex; flex-direction: column; border-top: 1px solid #333; }
        .modal-overlay.show { transform: translateY(0); }
        .modal-header { padding: 20px; text-align: center; border-bottom: 1px solid #222; }
        .modal-title { font-size: 18px; font-weight: 700; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .close-modal { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; color: #666; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
        .modal-content { flex: 1; overflow-y: auto; padding: 20px; color: white; padding-bottom: 80px; }

        /* SEARCH STYLES */
        .search-input { width: 100%; padding: 16px; background: #151a23; border: 1px solid #333; color: white; border-radius: 14px; font-size: 15px; outline: none; font-family: 'Manrope'; }
        .search-item { padding: 15px; background: rgba(255,255,255,0.03); border-radius: 12px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; margin-bottom: 8px; }
        .search-item:hover { border-color: var(--accent); background: rgba(212, 175, 55, 0.05); }

        /* CALENDAR TABLE */
        .prayer-table { width: 100%; border-collapse: collapse; min-width: 500px; }
        .prayer-table th { text-align: left; font-size: 10px; color: var(--text-tertiary); text-transform: uppercase; padding: 10px; border-bottom: 1px solid #333; vertical-align: bottom; }
        .prayer-table td { padding: 12px 10px; font-size: 13px; border-bottom: 1px solid #222; color: var(--text-secondary); }
        .prayer-table tr.today-row { background: rgba(212, 175, 55, 0.05); border-left: 2px solid var(--accent); }

        /* SHARE IMAGE */
        .share-card-container { background: radial-gradient(circle at 50% -10%, #1e2838 0%, #000000 70%); }
    </style>
</head>
<body>

<div id="star-bg">
    <div class="star-layer stars-1"></div>
    <div class="star-layer stars-2"></div>
</div>

<div class="container">
    <div class="top-bar">
        <button class="btn-mini" id="btnStats"><i class="ph ph-chart-bar"></i> –û—Ç—á–µ—Ç</button>
        <button class="btn-mini" id="btnCalendar"><i class="ph ph-calendar-blank"></i> –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
    </div>

    <a href="https://t.me/ametov_design" class="brand-link" target="_blank">
        –¢—Ä–µ–∫–µ—Ä –ê–∑–∏–∑–∞ –ê–º–µ—Ç–æ–≤–∞ ‚Üó
    </a>

    <div class="progress-header">
        <div class="circle-wrapper">
            <div class="nav-arrow" id="prevDay"><i class="ph ph-caret-left"></i></div>
            
            <div class="circle-container">
                <svg viewBox="0 0 160 160" style="transform: rotate(135deg);">
                    <circle class="circle-bg" cx="80" cy="80" r="70" stroke-dasharray="330 440"></circle>
                    <circle class="circle-progress" id="monthCircle" cx="80" cy="80" r="70" stroke-dasharray="330 440"></circle>
                </svg>
                <div class="day-info">
                    <div class="day-number" id="uiDayNum">1</div>
                    <div class="day-label" id="uiDayLabel">–î–µ–Ω—å</div>
                </div>
            </div>

            <div class="nav-arrow disabled" id="nextDay"><i class="ph ph-caret-right"></i></div>
        </div>
        
        <div class="greeting-text">
            –ê—Å—Å–∞–ª—è–º—É –∞–ª–µ–π–∫—É–º, –¥–∞–≤–∞–π –ø—Ä–æ–≤–µ–¥–µ–º<br>—ç—Ç–æ—Ç –º–µ—Å—è—Ü –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª–∫–∞—Ö?
        </div>
    </div>

    <div id="syncStatus">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div class="tracker-section">
        <div class="section-title" style="justify-content:center; margin-bottom:15px;"><i class="ph ph-moon-stars"></i> –ü–æ—Å—Ç —Å–µ–≥–æ–¥–Ω—è</div>
        
        <div class="fasting-switch">
            <div class="fasting-option" id="fastingNo" onclick="setFasting(false)">–ü—Ä–æ–ø—É—Å—Ç–∏–ª</div>
            <div class="fasting-option" id="fastingYes" onclick="setFasting(true)">–°–æ–±–ª—é–¥–∞—é</div>
        </div>
        
        <div class="fasting-times-block" id="fastingTimesBlock"></div>
    </div>

    <div class="tracker-section">
        <div class="section-header">
            <div class="section-title"><i class="ph ph-hands-praying"></i> –ù–∞–º–∞–∑</div>
            <div class="section-percent">0%</div>
        </div>
        <div class="progress-bar-bg"><div class="progress-bar-fill"></div></div>
        
        <div class="group-label">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ</div>
        <div class="task-item" onclick="toggleTask(this, 'fajr')"><span class="task-text">–§–∞–¥–∂—Ä</span><div class="checkbox"></div></div>
        <div class="task-item" onclick="toggleTask(this, 'dhuhr')"><span class="task-text">–ó—É—Ö—Ä</span><div class="checkbox"></div></div>
        <div class="task-item" onclick="toggleTask(this, 'asr')"><span class="task-text">–ê—Å—Ä</span><div class="checkbox"></div></div>
        <div class="task-item" onclick="toggleTask(this, 'maghrib')"><span class="task-text">–ú–∞–≥—Ä–∏–±</span><div class="checkbox"></div></div>
        <div class="task-item" onclick="toggleTask(this, 'isha')"><span class="task-text">–ò—à–∞</span><div class="checkbox"></div></div>
        
        <div class="group-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ</div>
        <div class="task-item" onclick="toggleTask(this, 'sunnah')"><span class="task-text">–°—É–Ω–Ω–∞ –Ω–∞–º–∞–∑—ã</span><div class="checkbox"></div></div>
        <div class="task-item" onclick="toggleTask(this, 'tarawih')"><span class="task-text">–¢–∞—Ä–∞–≤–∏—Ö</span><div class="checkbox"></div></div>
        <div class="task-item" onclick="toggleTask(this, 'witr')"><span class="task-text">–í–∏—Ç—Ä</span><div class="checkbox"></div></div>
        <div class="task-item" onclick="toggleTask(this, 'tahajjud')"><span class="task-text">–¢–∞—Ö–∞–¥–∂—É–¥</span><div class="checkbox"></div></div>
    </div>

    <div class="tracker-section">
        <div class="section-header">
            <div class="section-title"><i class="ph ph-book-open-text"></i> –ó–Ω–∞–Ω–∏—è</div>
            <div class="section-percent">0%</div>
        </div>
        <div class="progress-bar-bg"><div class="progress-bar-fill"></div></div>
        <div class="task-item">
            <span class="task-text" onclick="toggleTask(this.parentElement, 'quran_read')">–ß–∏—Ç–∞–ª –ö—ä—É—Ä'–∞–Ω</span>
            <input type="number" id="quranPages" class="page-input" placeholder="—Å—Ç—Ä." min="0" autocomplete="off" oninput="saveQuranPages(this.value)">
            <div class="checkbox" onclick="toggleTask(this.parentElement, 'quran_read')"></div>
        </div>
        <div class="task-item" onclick="toggleTask(this, 'lecture')"><span class="task-text">–ü—Ä–æ—Å–ª—É—à–∞–ª –ª–µ–∫—Ü–∏—é</span><div class="checkbox"></div></div>
        <div class="task-item" onclick="toggleTask(this, 'arabic')"><span class="task-text">–ò–∑—É—á–∞–ª –∞—Ä–∞–±—Å–∫–∏–π</span><div class="checkbox"></div></div>
    </div>

    <div class="tracker-section">
        <div class="section-header">
            <div class="section-title"><i class="ph ph-bowl-food"></i> –ü–∏—Ç–∞–Ω–∏–µ</div>
            <div class="section-percent">0%</div>
        </div>
        <div class="progress-bar-bg"><div class="progress-bar-fill"></div></div>
        
        <div class="task-item" style="cursor: default;">
            <span class="task-text">–í–æ–¥–∞ (—Å—Ç–∞–∫–∞–Ω - 500–º–ª)</span>
            <div class="water-row">
                <div class="water-glass" onclick="updateWater(1)"><svg viewBox="0 0 24 24"><path d="M5,5 L19,5 L17,21 L7,21 L5,5 Z"></path></svg></div>
                <div class="water-glass" onclick="updateWater(2)"><svg viewBox="0 0 24 24"><path d="M5,5 L19,5 L17,21 L7,21 L5,5 Z"></path></svg></div>
                <div class="water-glass" onclick="updateWater(3)"><svg viewBox="0 0 24 24"><path d="M5,5 L19,5 L17,21 L7,21 L5,5 Z"></path></svg></div>
                <div class="water-glass" onclick="updateWater(4)"><svg viewBox="0 0 24 24"><path d="M5,5 L19,5 L17,21 L7,21 L5,5 Z"></path></svg></div>
                <div class="water-glass" onclick="updateWater(5)"><svg viewBox="0 0 24 24"><path d="M5,5 L19,5 L17,21 L7,21 L5,5 Z"></path></svg></div>
            </div>
        </div>
        
        <div class="task-item" onclick="toggleTask(this, 'no_overeat')"><span class="task-text">–ù–µ –ø–µ—Ä–µ–µ–ª</span><div class="checkbox"></div></div>
    </div>

    <div class="tracker-section">
        <div class="section-header">
            <div class="section-title"><i class="ph ph-sparkle"></i> –õ–∏—á–Ω–æ—Å—Ç—å</div>
            <div class="section-percent">0%</div>
        </div>
        <div class="progress-bar-bg"><div class="progress-bar-fill"></div></div>
        
        <div class="task-item" onclick="toggleTask(this, 'sadaqah')"><span class="task-text">–°–¥–µ–ª–∞–ª —Å–∞–¥–∞–∫–∞</span><div class="checkbox"></div></div>
        <div class="task-item" onclick="toggleTask(this, 'no_bad_words')"><span class="task-text">–ù–µ –∑–ª–æ—Å–ª–æ–≤–∏–ª</span><div class="checkbox"></div></div>
        <div class="task-item" onclick="toggleTask(this, 'no_gossip')"><span class="task-text">–ù–µ —Å–ø–ª–µ—Ç–Ω–∏—á–∞–ª</span><div class="checkbox"></div></div>
        
        <div class="group-label">–ú–æ–∏ —Ü–µ–ª–∏</div>
        
        <div id="extraGoalsContainer"></div>

        <div class="add-goal-area" style="display:flex; gap:10px; margin-top:15px;">
            <input type="text" class="custom-input" id="newGoalInput" autocomplete="off" placeholder="–ù–∞–ø–∏—à–∏ —Å–≤–æ—é —Ü–µ–ª—å...">
            <div class="btn-plus" onclick="addNewGoalFromInput()">+</div>
        </div>
    </div>

    <div class="tracker-section">
        <div class="section-title"><i class="ph ph-pencil-simple"></i> –ú—ã—Å–ª–∏ –∑–∞ –¥–µ–Ω—å</div>
        <textarea id="dailyThoughts" class="journal-area" autocomplete="off" placeholder="–ß—Ç–æ —Å–µ–≥–æ–¥–Ω—è –æ—Å–æ–∑–Ω–∞–ª? –ó–∞ —á—Ç–æ –±–ª–∞–≥–æ–¥–∞—Ä–µ–Ω?..." oninput="saveThoughts()"></textarea>
    </div>

    <div class="tracker-section">
        <div class="section-title" style="justify-content:center;"><i class="ph ph-star"></i> –û—Ü–µ–Ω–∫–∞ –¥–Ω—è</div>
        <div class="stars">
            <div class="star" data-val="1">‚òÖ</div>
            <div class="star" data-val="2">‚òÖ</div>
            <div class="star" data-val="3">‚òÖ</div>
            <div class="star" data-val="4">‚òÖ</div>
            <div class="star" data-val="5">‚òÖ</div>
        </div>
    </div>

    <div class="bottom-actions">
        <button class="btn-finish" id="btnFinish">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–µ–Ω—å</button>
        <button class="btn-share" id="btnShare"><i class="ph ph-export"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
    </div>
</div>

<div class="modal-overlay" id="modalCalendar">
    <div class="modal-header">
        <div class="modal-title" id="calTitle">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
        <div class="close-modal" onclick="closeModal('modalCalendar')">√ó</div>
    </div>
    <div class="modal-content" id="calContent"></div>
</div>

<div class="modal-overlay" id="modalStats">
    <div class="modal-header">
        <div class="modal-title">üìä –¢–≤–æ–π –û—Ç—á–µ—Ç</div>
        <div class="close-modal" onclick="closeModal('modalStats')">√ó</div>
    </div>
    <div class="modal-content">
        <div class="group-label" style="margin-bottom:10px;">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –¥–Ω—è–º</div>
        <div class="heatmap-grid" id="heatmapGrid" style="display:grid; grid-template-columns:repeat(6,1fr); gap:6px;"></div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:16px; text-align:center; border:1px solid #333;">
                <div style="font-size:24px; font-weight:800; color:var(--accent);" id="statDays">0</div><div style="font-size:11px; color:#aaa;">–î–Ω–µ–π –ø—Ä–æ–π–¥–µ–Ω–æ</div>
            </div>
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:16px; text-align:center; border:1px solid #333;">
                <div style="font-size:24px; font-weight:800; color:var(--accent);" id="statRating">0.0</div><div style="font-size:11px; color:#aaa;">–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞</div>
            </div>
        </div>

        <div class="ai-feedback" style="margin-bottom:10px; padding:15px; background:rgba(255,255,255,0.03); border-radius:12px;">
            <div style="font-weight:700; color:#fff; margin-bottom:5px;">ü§ñ –ú–Ω–µ–Ω–∏–µ —Ç—Ä–µ–∫–µ—Ä–∞</div>
            <div style="font-size:13px; color:#ccc; line-height:1.4;" id="aiText">...</div>
        </div>
        <div id="statFullList"></div>
    </div>
</div>

<div class="modal-overlay" id="modalShare">
    <div class="modal-header">
        <div class="modal-title">üì∏ –ü–æ–¥–µ–ª–∏—Å—å —É—Å–ø–µ—Ö–æ–º</div>
        <div class="close-modal" onclick="closeModal('modalShare')">√ó</div>
    </div>
    <div class="modal-content" style="display:flex; flex-direction:column; align-items:center;">
        <div class="share-wrapper" style="position:relative; width:100%; margin-bottom:20px;">
            <div class="share-card-container" id="shareCardToRender" style="width:100%; padding-bottom:100%; position:relative; border-radius:24px; border:1px solid #333; overflow:hidden;">
                <div class="share-content" style="position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; justify-content:space-between; padding:20px; text-align:center; z-index:10;">
                     <div class="share-top-part">
                        <div class="share-date" id="shareDate" style="font-size:14px; text-transform:uppercase; letter-spacing:2px; color:#888;">...</div>
                    </div>
                    <div id="shareRegularContent" style="display:contents;">
                        <div class="share-center-part" style="display:flex; flex-direction:column; align-items:center; justify-content:center; flex-grow:1;">
                            <div class="share-circle-wrap" style="width:140px; height:140px; position:relative; margin-bottom:15px; display:flex; align-items:center; justify-content:center;">
                                 <svg style="position:absolute; top:0; left:0; width:100%; height:100%; transform:rotate(-90deg);">
                                    <circle cx="80" cy="80" r="70" style="stroke:rgba(255,255,255,0.1); stroke-width:8; fill:none;"></circle>
                                    <circle id="shareCircle" stroke="#d4af37" stroke-width="8" fill="none" cx="80" cy="80" r="70" stroke-linecap="round" stroke-dasharray="440" stroke-dashoffset="440"></circle>
                                </svg>
                                <div style="z-index:5; text-align:center;">
                                    <div class="share-day-num" id="shareDayNum" style="font-size:52px; font-weight:800; color:#fff; line-height:1;">1</div>
                                    <div style="font-size:10px; color:#aaa; text-transform:uppercase;">–î–ï–ù–¨</div>
                                </div>
                            </div>
                            <div class="share-ai-text" id="shareAiText" style="font-size:15px; color:#eee; font-style:italic;">...</div>
                            <div class="stars" id="shareStars"></div>
                        </div>
                    </div>
                     <div class="share-bottom-part">
                        <div style="font-size:10px; color:#aaa; font-weight:700; text-transform:uppercase;">–¢—Ä–µ–∫–µ—Ä –†–∞–º–∞–¥–∞–Ω</div>
                        <div style="font-size:12px; color:#d4af37; font-weight:800;">@ramadantracking_bot</div>
                    </div>
                </div>
            </div>
            <div id="generatedImageContainer" style="display:none; width:100%; border-radius:24px; overflow:hidden;"></div>
        </div>
        <button class="btn-share" id="btnGenImage" onclick="generateAndSend()" style="width:100%;">–°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É</button>
        <p style="text-align:center; font-size:12px; color:#666; margin-top:10px;" id="shareHint">–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É</p>
    </div>
</div>

<div class="modal-overlay" id="modalFinal">
    <div class="modal-header">
        <div class="modal-title">üéâ –ò—Ç–æ–≥–∏</div>
        <div class="close-modal" onclick="closeModal('modalFinal')">√ó</div>
    </div>
    <div class="modal-content">
        <div style="text-align:center; margin-bottom:20px;">
            <div style="font-size:22px; font-weight:800; color:var(--accent);">–¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:16px; text-align:center;">
                <div style="font-size:24px; font-weight:800; color:var(--accent);" id="f_avg">0%</div><div style="font-size:11px;">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
            </div>
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:16px; text-align:center;">
                <div style="font-size:24px; font-weight:800; color:var(--accent);" id="f_fast">0</div><div style="font-size:11px;">–ü—Ä–æ–ø—É—Å—Ç–∏–ª</div>
            </div>
        </div>
        <div id="f_fullList" style="margin-top:20px;"></div>
        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:16px; margin-top:15px;">
            <div style="color:var(--accent); font-weight:700; margin-bottom:5px;">–†–æ–±–æ—Ç –≥–æ–≤–æ—Ä–∏—Ç:</div>
            <div id="f_robot" style="font-size:13px; color:#ccc;">...</div>
        </div>
    </div>
</div>

<script>
    let tg = window.Telegram ? window.Telegram.WebApp : null;
    if (tg) { tg.expand(); tg.MainButton.hide(); tg.setHeaderColor('#090e16'); tg.setBackgroundColor('#080a0f'); }

    window.addEventListener('scroll', () => {
        const scrolled = window.scrollY;
        document.querySelector('.stars-1').style.transform = `translateY(${scrolled * 0.3}px)`;
        document.querySelector('.stars-2').style.transform = `translateY(${scrolled * 0.2}px)`;
    });

    const SCORES = {
        fasting: 15,
        fajr: 8, dhuhr: 8, asr: 8, maghrib: 8, isha: 8,
        sunnah: 2, tarawih: 2, witr: 2, tahajjud: 2,
        quran_read: 8, lecture: 6, arabic: 4,
        sadaqah: 5,
        no_bad_words: 3, no_gossip: 3, 
        no_overeat: 3 
    };

    const ramadanStart = new Date(2026, 01, 01);
    const STORAGE_KEY = 'ramadan_tracker_stable_db';
    const CALENDAR_STORAGE_KEY = 'ramadan_api_calendar_v1';
    const CITY_NAME_KEY = 'ramadan_city_name_v1';

    function getCurrentDay() {
        const now = new Date();
        const startZero = new Date(ramadanStart.getFullYear(), ramadanStart.getMonth(), ramadanStart.getDate());
        const nowZero = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const diff = nowZero - startZero;
        let day = Math.ceil(diff / (1000 * 60 * 60 * 24)) + 1;
        if (day < 1) return 1;
        return day > 30 ? 30 : day;
    }

    let realDayNum = getCurrentDay();
    let activeDayNum = realDayNum;
    let fullHistory = {};

    function initApp() {
        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && !localStorage.getItem('user_data_sent_v1')) {
            // Log logic here if needed
            localStorage.setItem('user_data_sent_v1', 'true');
        }

        try {
            if (tg && tg.CloudStorage) {
                tg.CloudStorage.getItem(STORAGE_KEY, (err, val) => {
                    if (!err && val) { 
                        try { fullHistory = JSON.parse(val); document.getElementById('syncStatus').innerText = "‚òÅÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ"; }
                        catch(e) { fullHistory = {}; }
                    } else { 
                        const loc = localStorage.getItem(STORAGE_KEY);
                        if(loc) { fullHistory = JSON.parse(loc); saveData(); }
                        document.getElementById('syncStatus').innerText = "‚ú® –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"; 
                    }
                    renderDay(activeDayNum);
                });
            } else {
                const loc = localStorage.getItem(STORAGE_KEY);
                if(loc) fullHistory = JSON.parse(loc);
                renderDay(activeDayNum);
            }
        } catch(e) { renderDay(activeDayNum); }
    }

    function calculateDayScore(dayData) {
        if (!dayData) return 0;
        let score = 0;
        if (dayData.fasting === true) score += SCORES.fasting;
        if (dayData.tasks) {
            for (let task in dayData.tasks) {
                if (dayData.tasks[task] && SCORES[task]) score += SCORES[task];
            }
        }
        if (dayData.water) {
            if (dayData.water >= 2) score += 3; else score += (dayData.water * 1.5);
        }
        if (dayData.extraGoals) {
            dayData.extraGoals.forEach(g => { if(g.done) score += 7; });
        }
        return score > 100 ? 100 : Math.round(score);
    }

    function getStoredCalendar() {
        const str = localStorage.getItem(CALENDAR_STORAGE_KEY);
        return str ? JSON.parse(str) : null;
    }

    function renderDay(dayNum) {
        document.getElementById('uiDayNum').innerText = dayNum;
        document.getElementById('prevDay').classList.toggle('disabled', dayNum <= 1);
        document.getElementById('nextDay').classList.toggle('disabled', dayNum >= realDayNum);
        
        const data = fullHistory[dayNum] || { tasks: {}, customText: "", rating: 0, thoughts: "", fasting: false, extraGoals: [], water: 0, quranPageCount: "" };
        if(!data.tasks) data.tasks = {};

        const isFasting = (data.fasting === true); 
        const btnYes = document.getElementById('fastingYes');
        const btnNo = document.getElementById('fastingNo');
        btnYes.className = 'fasting-option';
        btnNo.className = 'fasting-option';
        if(isFasting) btnYes.classList.add('active-hold'); else btnNo.classList.add('active-nothold');

        // Calendar Times
        const timeBlock = document.getElementById('fastingTimesBlock');
        const calendar = getStoredCalendar();
        
        if(calendar && calendar[dayNum-1]) {
            const times = calendar[dayNum-1];
            const cityName = localStorage.getItem(CITY_NAME_KEY) || "–ì–æ—Ä–æ–¥";
            timeBlock.innerHTML = `
                <div class="time-row">
                    <div class="time-item"><span class="time-label">–°—É—Ö—É—Ä</span><span class="time-val">${times.fajr}</span></div>
                    <div style="width:1px; height:30px; background:rgba(255,255,255,0.1)"></div>
                    <div class="time-item"><span class="time-label">–ò—Ñ—Ç–∞—Ä</span><span class="time-val" style="color:var(--accent)">${times.maghrib}</span></div>
                </div>
                <div style="font-size:10px; color:var(--text-tertiary); margin-top:8px;">üìç ${cityName} <span onclick="openCityModal()" style="text-decoration:underline; cursor:pointer;">(—Å–º–µ–Ω–∏—Ç—å)</span></div>
            `;
        } else {
            timeBlock.innerHTML = `<button class="btn-set-city" onclick="openCityModal()" style="width:100%; padding:10px; background:transparent; border:1px dashed #444; color:#888; border-radius:10px;">üìç –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä–µ–º—è (–ì–æ—Ä–æ–¥)</button>`;
        }

        document.querySelectorAll('.task-item').forEach(el => el.classList.remove('checked'));
        for(const [id, done] of Object.entries(data.tasks)) {
            if(done) {
                const els = document.querySelectorAll('.task-item');
                els.forEach(el => {
                    if(el.getAttribute('onclick') && el.getAttribute('onclick').includes(`'${id}'`)) el.classList.add('checked');
                    if(!el.getAttribute('onclick') && id === 'quran_read' && el.querySelector(`[onclick*="'quran_read'"]`)) el.classList.add('checked');
                });
            }
        }
        
        const waterVal = data.water || 0;
        document.querySelectorAll('.water-glass').forEach((el, idx) => {
            if (idx < waterVal) el.classList.add('filled');
            else el.classList.remove('filled');
        });

        document.getElementById('quranPages').value = data.quranPageCount || "";
        document.getElementById('dailyThoughts').value = data.thoughts || "";

        const extraContainer = document.getElementById('extraGoalsContainer');
        extraContainer.innerHTML = '';
        if(data.extraGoals && data.extraGoals.length > 0) {
            data.extraGoals.forEach((goal, idx) => {
                const checked = goal.done ? 'checked' : '';
                const html = `
                <div class="task-item ${checked}" style="margin-bottom:1px;">
                     <span class="task-text" onclick="toggleExtraGoal(${idx})">${goal.text}</span>
                     <div class="checkbox" onclick="toggleExtraGoal(${idx})"></div>
                     <div style="color:#444; padding:0 10px; font-size:18px;" onclick="removeExtraGoal(${idx})">√ó</div>
                </div>`;
                extraContainer.insertAdjacentHTML('beforeend', html);
            });
        }
        document.getElementById('newGoalInput').value = "";
        const r = data.rating || 0;
        document.querySelectorAll('.star').forEach(s => s.classList.toggle('active', parseInt(s.dataset.val) <= r));
        document.querySelectorAll('.tracker-section').forEach(updateSectionProgress);
        updateDailyCircle();
    }

    // --- –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –ö–†–£–ì–ê (330 MAX) ---
    function updateDailyCircle() {
        const score = calculateDayScore(fullHistory[activeDayNum]);
        const percent = score / 100;
        // Max is 330.
        const offset = 330 - (percent * 330);
        
        const circle = document.getElementById('monthCircle');
        circle.style.strokeDashoffset = offset;
        
        if(percent < 0.3) circle.style.stroke = "#e74c3c"; 
        else if(percent < 0.8) circle.style.stroke = "#d4af37"; 
        else circle.style.stroke = "#27ae60"; 
    }

    window.updateWater = function(count) {
        ensureDayObj(activeDayNum);
        const current = fullHistory[activeDayNum].water || 0;
        if (current === count) fullHistory[activeDayNum].water = count - 1;
        else { fullHistory[activeDayNum].water = count; hapticBurst(1); }
        renderDay(activeDayNum); saveData();
    }

    let quranSaveTimeout;
    window.saveQuranPages = function(val) {
        ensureDayObj(activeDayNum);
        if (val < 0) val = 0;
        fullHistory[activeDayNum].quranPageCount = val;
        if(val && val > 0 && !fullHistory[activeDayNum].tasks['quran_read']) {
            fullHistory[activeDayNum].tasks['quran_read'] = true;
            renderDay(activeDayNum); 
        }
        clearTimeout(quranSaveTimeout); quranSaveTimeout = setTimeout(saveData, 500);
    }

    window.setFasting = function(val) {
        ensureDayObj(activeDayNum);
        fullHistory[activeDayNum].fasting = val;
        renderDay(activeDayNum); saveData();
        if(val) hapticBurst(SCORES.fasting); else haptic();
    }
    
    window.openCityModal = function() { document.getElementById('btnCalendar').click(); }

    window.addNewGoalFromInput = function() {
        const inp = document.getElementById('newGoalInput'); const val = inp.value.trim();
        if(!val) return;
        ensureDayObj(activeDayNum);
        if(!fullHistory[activeDayNum].extraGoals) fullHistory[activeDayNum].extraGoals = [];
        fullHistory[activeDayNum].extraGoals.push({ text: val, done: false });
        renderDay(activeDayNum); saveData(); haptic();
    }

    window.removeExtraGoal = function(idx) {
        if(!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
        ensureDayObj(activeDayNum); fullHistory[activeDayNum].extraGoals.splice(idx, 1);
        renderDay(activeDayNum); saveData();
    }

    window.toggleExtraGoal = function(idx) {
        ensureDayObj(activeDayNum);
        const current = fullHistory[activeDayNum].extraGoals[idx].done;
        fullHistory[activeDayNum].extraGoals[idx].done = !current;
        renderDay(activeDayNum); saveData(); 
        if(!current) hapticBurst(4); else haptic();
    }

    function updateSectionProgress(section) {
        const title = section.querySelector('.section-title').innerText;
        let percent = 0;
        if(title.includes("–õ–∏—á–Ω–æ—Å—Ç—å")) {
             ensureDayObj(activeDayNum); const data = fullHistory[activeDayNum];
             let total = 3; let checked = 0;
             if(data && data.tasks) {
                 if(data.tasks.no_bad_words) checked++; if(data.tasks.no_gossip) checked++; if(data.tasks.sadaqah) checked++;
             }
             if(data && data.extraGoals) {
                 total += data.extraGoals.length; data.extraGoals.forEach(g => { if(g.done) checked++; });
             }
             if(total === 0) percent = 0; else percent = Math.round((checked / total) * 100);
        } else if(title.includes("–ü–∏—Ç–∞–Ω–∏–µ")) {
            ensureDayObj(activeDayNum);
            const water = fullHistory[activeDayNum] ? (fullHistory[activeDayNum].water || 0) : 0;
            const notOvereat = section.querySelector('.task-item.checked') ? 1 : 0;
            percent = Math.round(((water + notOvereat) / 6) * 100);
        } else {
            const totalItems = section.querySelectorAll('.task-item').length;
            if(totalItems === 0) return; 
            const checkedItems = section.querySelectorAll('.task-item.checked').length;
            percent = Math.round((checkedItems / totalItems) * 100);
        }
        const fill = section.querySelector('.progress-bar-fill');
        const text = section.querySelector('.section-percent');
        if(fill && text) {
            fill.style.width = percent + "%"; text.innerText = percent + "%";
            fill.style.backgroundColor = (percent === 100) ? "#27ae60" : "#d4af37";
        }
    }

    document.getElementById('prevDay').addEventListener('click', () => { if(activeDayNum>1){activeDayNum--; renderDay(activeDayNum); haptic();} });
    document.getElementById('nextDay').addEventListener('click', () => { if(activeDayNum<realDayNum){activeDayNum++; renderDay(activeDayNum); haptic();} });
    
    window.toggleTask = function(el, id) { 
        if(event.target.tagName === 'INPUT') return;
        if(el.classList.contains('task-text') || el.classList.contains('checkbox')) el = el.parentElement;
        el.classList.toggle('checked'); ensureDayObj(activeDayNum); 
        const isChecked = el.classList.contains('checked');
        fullHistory[activeDayNum].tasks[id] = isChecked; 
        updateSectionProgress(el.closest('.tracker-section')); updateDailyCircle(); saveData(); 
        if(isChecked) { const points = SCORES[id] || 1; hapticBurst(points); } else haptic(); 
    }
    
    let thoughtsSaveTimeout;
    window.saveThoughts = function() { 
        ensureDayObj(activeDayNum); fullHistory[activeDayNum].thoughts = document.getElementById('dailyThoughts').value; 
        clearTimeout(thoughtsSaveTimeout); thoughtsSaveTimeout = setTimeout(saveData, 500); 
    }

    document.querySelectorAll('.star').forEach(s => s.addEventListener('click', function() { ensureDayObj(activeDayNum); fullHistory[activeDayNum].rating = parseInt(this.dataset.val); renderDay(activeDayNum); saveData(); haptic(); }));

    function ensureDayObj(d){ if(!fullHistory[d]) fullHistory[d] = {tasks:{}, customText:"", rating:0, thoughts:"", fasting:false, extraGoals:[], water:0, quranPageCount:""}; }
    
    function saveData(){
        const val = JSON.stringify(fullHistory);
        const status = document.getElementById('syncStatus');
        status.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
        const key = STORAGE_KEY;
        const cb = (e) => { if(!e) { status.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"; status.classList.add('active'); setTimeout(() => status.classList.remove('active'), 1000); } };
        if(tg && tg.CloudStorage) tg.CloudStorage.setItem(key, val, cb);
        else { localStorage.setItem(key, val); cb(null); }
    }
    
    function haptic(){ if(tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); }
    function hapticBurst(count) {
        if (!tg || !tg.HapticFeedback) return;
        if(count > 20) count = 20; 
        let i = 0; let interval = setInterval(() => { tg.HapticFeedback.impactOccurred('light'); i++; if (i >= count) clearInterval(interval); }, 40); 
    }
    
    window.closeModal = function(id){ document.getElementById(id).classList.remove('show'); document.body.classList.remove('no-scroll'); }

    // === API LOGIC ===
    document.getElementById('btnCalendar').addEventListener('click', () => {
        document.body.classList.add('no-scroll');
        renderCalendarUI();
        document.getElementById('modalCalendar').classList.add('show');
    });

    function renderCalendarUI() {
        const container = document.getElementById('calContent');
        const calendar = getStoredCalendar();
        if (!calendar) renderSearchUI(container); else renderTableUI(container, calendar);
    }

    function renderSearchUI(container) {
        container.innerHTML = `
            <div class="search-container">
                <input type="text" class="search-input" id="citySearchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–∞–∑–∞–Ω—å)">
                <div id="searchResults" style="margin-top:10px;"></div>
            </div>
        `;
        const inp = document.getElementById('citySearchInput');
        let debounce;
        inp.addEventListener('input', (e) => {
            clearTimeout(debounce);
            debounce = setTimeout(() => searchCity(e.target.value), 600);
        });
    }

    // --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ü–û–ò–°–ö (–ë–ï–ó –°–¢–†–ê–ù–´) ---
    function searchCity(query) {
        if(query.length < 3) return;
        const resDiv = document.getElementById('searchResults');
        resDiv.innerHTML = '<div style="text-align:center;color:#666;">–ü–æ–∏—Å–∫...</div>';
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&accept-language=ru`)
            .then(r => r.json())
            .then(data => {
                resDiv.innerHTML = '';
                if(data.length === 0) { resDiv.innerHTML = '<div style="text-align:center;color:#666;">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
                
                data.slice(0, 5).forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'search-item';
                    
                    // –ë–ï–†–ï–ú –¢–û–õ–¨–ö–û –ü–ï–†–í–£–Æ –ß–ê–°–¢–¨ –î–û –ó–ê–ü–Ø–¢–û–ô
                    const simpleName = item.display_name.split(',')[0];
                    
                    el.innerText = simpleName; 
                    el.onclick = () => loadCalendarForLocation(item.lat, item.lon, simpleName);
                    resDiv.appendChild(el);
                });
            })
            .catch(() => { resDiv.innerHTML = '<div style="text-align:center;color:#e74c3c;">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>'; });
    }

    function loadCalendarForLocation(lat, lon, cityName) {
        const resDiv = document.getElementById('searchResults');
        resDiv.innerHTML = '<div style="text-align:center;color:var(--accent);">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...</div>';
        
        const p1 = fetch(`https://api.aladhan.com/v1/calendar?latitude=${lat}&longitude=${lon}&method=3&month=2&year=2026`).then(r=>r.json());
        const p2 = fetch(`https://api.aladhan.com/v1/calendar?latitude=${lat}&longitude=${lon}&method=3&month=3&year=2026`).then(r=>r.json());

        Promise.all([p1, p2]).then(([d1, d2]) => {
            let finalCalendar = [];
            // –°–æ–±–∏—Ä–∞–µ–º 30 –¥–Ω–µ–π –Ω–∞—á–∏–Ω–∞—è —Å 1 —Ñ–µ–≤—Ä–∞–ª—è 2026
            for(let i=0; i<30; i++) {
                let dayObj;
                if (i < 28) dayObj = d1.data[i]; // –§–µ–≤—Ä–∞–ª—å 2026
                else dayObj = d2.data[i - 28]; // –ú–∞—Ä—Ç 2026
                
                if(dayObj) {
                    finalCalendar.push({
                        date: dayObj.date.readable,
                        fajr: dayObj.timings.Fajr.split(' ')[0],
                        dhuhr: dayObj.timings.Dhuhr.split(' ')[0],
                        asr: dayObj.timings.Asr.split(' ')[0],
                        maghrib: dayObj.timings.Maghrib.split(' ')[0],
                        isha: dayObj.timings.Isha.split(' ')[0]
                    });
                }
            }
            
            localStorage.setItem(CALENDAR_STORAGE_KEY, JSON.stringify(finalCalendar));
            localStorage.setItem(CITY_NAME_KEY, cityName);
            renderTableUI(document.getElementById('calContent'), finalCalendar);
            renderDay(activeDayNum);
        });
    }

    function renderTableUI(container, calendar) {
        const cityName = localStorage.getItem(CITY_NAME_KEY) || "–ì–æ—Ä–æ–¥";
        let h = `<div style="text-align:center; margin-bottom:15px; font-weight:700; color:var(--accent);">üìç ${cityName}</div>`;
        h += `<button class="btn-set-city" onclick="resetCity()" style="width:100%; margin-bottom:15px; border:1px solid #444; background:transparent; padding:10px; border-radius:10px; color:#fff;">üîÑ –°–º–µ–Ω–∏—Ç—å –≥–æ—Ä–æ–¥</button>`;
        h += `<div class="prayer-table-container"><table class="prayer-table"><thead><tr><th>–î</th><th>–§–∞–¥–∂—Ä</th><th>–ó—É—Ö—Ä</th><th>–ê—Å—Ä</th><th>–ú–∞–≥—Ä–∏–±</th><th>–ò—à–∞</th></tr></thead><tbody>`;
        
        calendar.forEach((day, idx) => {
            let isT = (idx+1)===activeDayNum ? 'class="today-row"' : '';
            h += `<tr ${isT}>
                <td>${idx+1}</td>
                <td style="color:#fff">${day.fajr}</td>
                <td>${day.dhuhr}</td>
                <td>${day.asr}</td>
                <td style="color:var(--accent); font-weight:700;">${day.maghrib}</td>
                <td>${day.isha}</td>
            </tr>`;
        });
        h += `</tbody></table></div>`;
        container.innerHTML = h;
    }

    window.resetCity = function() {
        localStorage.removeItem(CALENDAR_STORAGE_KEY);
        renderCalendarUI();
    }

    // === STATS & OTHERS ===
    document.getElementById('btnStats').addEventListener('click', () => {
        document.body.classList.add('no-scroll');
        let d=0, r=0, totalPercent=0;
        const grid = document.getElementById('heatmapGrid'); grid.innerHTML = ''; 
        for(let i=1; i<=30; i++) {
            const dayData = fullHistory[i];
            const score = dayData ? calculateDayScore(dayData) : 0;
            const cell = document.createElement('div'); 
            cell.style.cssText = "aspect-ratio:1/1; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; border:1px solid #333; background:#111; color:#555;";
            
            if(dayData && calculateDayScore(dayData) > 0) {
                cell.innerText = score; 
                if(score >= 80) { cell.style.background = "var(--green)"; cell.style.color="#fff"; }
                else if(score >= 40) { cell.style.background = "var(--accent)"; cell.style.color="#000"; }
                else { cell.style.background = "var(--red)"; cell.style.color="#fff"; }
                d++; totalPercent += score; r += (dayData.rating || 0);
            } else { cell.innerText = i; }
            grid.appendChild(cell);
        }
        document.getElementById('statDays').innerText=d; 
        document.getElementById('statRating').innerText=d>0?(r/d).toFixed(1):"0.0";
        const avg = d > 0 ? (totalPercent / d) : 0;
        let msg = avg > 70 ? "–ú–∞—à–∞–ê–ª–ª–∞—Ö, –æ—Ç–ª–∏—á–Ω—ã–π —Ç–µ–º–ø!" : "–ü–æ–¥–Ω–∞–∂–º–∏, –±—Ä–∞—Ç!";
        document.getElementById('aiText').innerText = msg;
        document.getElementById('modalStats').classList.add('show');
    });

    document.getElementById('btnFinish').addEventListener('click', function() { 
        saveData(); 
        const btn = this; const originalText = btn.innerText; btn.innerText = "–°–û–•–†–ê–ù–ï–ù–û!"; btn.classList.add('saved');
        if(tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        setTimeout(() => { btn.innerText = originalText; btn.classList.remove('saved'); }, 2000);
    });

    // SHARE LOGIC (Simple)
    document.getElementById('btnShare').addEventListener('click', () => {
        document.body.classList.add('no-scroll');
        const d = fullHistory[activeDayNum] || {}; const score = calculateDayScore(d);
        document.getElementById('shareDayNum').innerText = activeDayNum;
        document.getElementById('shareAiText').innerText = score > 50 ? "–û—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å!" : "–°—Ç–∞—Ä–∞—é—Å—å —Ä–∞–¥–∏ –ê–ª–ª–∞—Ö–∞";
        
        // Render simple stars
        let stars = ''; const r = d.rating || 0;
        for(let i=1; i<=5; i++) stars += `<span style="color:${i<=r ? '#d4af37':'#333'}">‚òÖ</span>`;
        document.getElementById('shareStars').innerHTML = stars;
        
        document.getElementById('modalShare').classList.add('show');
    });

    window.generateAndSend = function() {
        const btn = document.getElementById('btnGenImage');
        btn.innerText = "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...";
        html2canvas(document.getElementById('shareCardToRender'), { scale: 2, useCORS: true }).then(canvas => {
            const imgData = canvas.toDataURL("image/png");
            const imgContainer = document.getElementById('generatedImageContainer');
            imgContainer.innerHTML = `<img src="${imgData}" style="width:100%;">`;
            imgContainer.style.display = 'block';
            document.getElementById('shareCardToRender').style.display = 'none';
            btn.innerText = "–ì–æ—Ç–æ–≤–æ (—Å–æ—Ö—Ä–∞–Ω–∏ —Ñ–æ—Ç–æ)";
        });
    }

    initApp();
</script>
</body>
</html>
